<!DOCTYPE html>
<html lang="zh-TW">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>示警通報預定</title>
	<meta property="og:description" content="衛星影像分析資訊平台" />
	<meta property="og:image" content="/images/OIL.png" />

	<!-- LIFF SDK -->
	<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
	<!-- Vue CDN -->
	<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
	<!-- CSS -->
	<style>
		body {
			padding: 40px 20px;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			gap: 40px;
			background: linear-gradient(to right, #155252, #33747B);
		}

		h1,
		h2,
		p,
		span {
			color: white;
			margin: 0;
		}

		.container {
			width: 100%;
			max-width: 400px;
			text-align: center;
		}

		.verifyContainer,
		.subscriptionContainer {
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 10px;
			background: rgba(255, 255, 255, 0.1);
			padding: 20px;
			border-radius: 10px;
			width: 100%;
		}

		input,
		button {
			padding: 10px;
			font-size: 16px;
			border-radius: 5px;
			border: none;
			width: 100%;
		}

		button {
			background-color: white;
			cursor: pointer;
		}

		.subscriptionBtn {
			padding: 10px;
			background: white;
			color: black;
			border-radius: 5px;
			cursor: pointer;
			margin-top: 10px;
		}
	</style>
</head>

<body>
	<div id="app" class="container">
		<h2>{{ userName }}，您好！</h2>

		<!-- 驗證區塊 -->
		<div v-if="!isVerified" class="verifyContainer">
			<p>你還沒有驗證唷！請先填入你的信箱</p>
			<input type="email" v-model="email" placeholder="請輸入 Email">
			<button @click="sendVerifyCode" :disabled="isSending">寄送驗證碼</button>
			<input type="number" v-model="verifyCode" placeholder="輸入驗證碼" :disabled="!hasSentCode">
			<button @click="checkVerifyCode" :disabled="!hasSentCode">驗證</button>
		</div>

		<!-- 訂閱功能 -->
		<div v-if="isVerified" class="subscriptionContainer">
			<h1>請選擇欲訂閱的資訊</h1>
			<div v-for="(status, key) in subscriptions" :key="key" class="subscriptionBtn" :style="{ backgroundColor: status ? 'red' : 'white' }" @click="toggleSubscription(key)">
				{{ subscriptionNames[key] }} - {{ status ? '取消訂閱' : '訂閱' }}
			</div>
		</div>
	</div>

	<script>
		const { createApp, ref } = Vue;

		createApp({
			setup() {
				const apiUrl = 'https://line-dotnet-api.onrender.com/';
				const liffId = '2006807429-YpKnwjVL';

				let userId = ref("");
				let userName = ref("");
				let email = ref("");
				let verifyCode = ref("");
				let isVerified = ref(false);
				let isSending = ref(false);
				let hasSentCode = ref(false);
				let subscriptions = ref({
					oceaN_POLLUTION: false,
					oiL_REPORT: false,
					satellitE_IMAGES: false
				});

				let subscriptionNames = {
					oceaN_POLLUTION: "海洋汙染事件",
					oiL_REPORT: "影像油汙報告",
					satellitE_IMAGES: "最新衛星影像"
				};

				async function initLIFF() {
					await liff.init({ liffId, withLoginOnExternalBrowser: true });
					const profile = await liff.getProfile();
					userId.value = profile.userId;
					userName.value = profile.displayName;
					checkUserExists();
				}

				async function checkUserExists() {
					try {
						let res = await fetch(apiUrl + '/api/LineLogin/CheckUserCombineLine', {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({ LINE_ID: userId.value })
						});
						let data = await res.json();
						isVerified.value = data.exists;

						if (data.exists) {
							fetchSubscriptions();
						}
					} catch (err) {
						console.error('❌ 檢查使用者失敗:', err);
					}
				}

				async function sendVerifyCode() {
					if (!email.value) {
						alert("請輸入有效的 Email");
						return;
					}
					isSending.value = true;
					try {
						let res = await fetch(apiUrl + '/api/LineLogin/SendVerifyCode', {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({ EMAIL: email.value })
						});
						let data = await res.json();
						if (data.success) {
							hasSentCode.value = true;
							alert("驗證碼已發送");
						} else {
							alert("發送失敗");
						}
					} catch (err) {
						console.error('❌ 發送驗證碼失敗:', err);
					}
					isSending.value = false;
				}

				async function checkVerifyCode() {
					if (!verifyCode.value) {
						alert("請輸入驗證碼");
						return;
					}
					try {
						let res = await fetch(apiUrl + '/api/LineLogin/CheckVerifyCode', {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({ EMAIL: email.value, CODE: verifyCode.value })
						});
						let data = await res.json();
						if (data.success) {
							saveUserInfo();
						} else {
							alert("驗證碼錯誤");
						}
					} catch (err) {
						console.error('❌ 驗證碼失敗:', err);
					}
				}

				async function saveUserInfo() {
					await fetch(apiUrl + '/api/LineLogin/SaveUser', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ EMAIL: email.value, LINE_ID: userId.value, COMBINE_LINE: 1 })
					});
					isVerified.value = true;
					fetchSubscriptions();
				}

				async function fetchSubscriptions() {
					let res = await fetch(apiUrl + '/api/Subscription/Fetch', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ USER_ID: userId.value })
					});
					subscriptions.value = await res.json();
				}

				async function toggleSubscription(key) {
					subscriptions.value[key] = !subscriptions.value[key];
				}

				initLIFF();
				return { userName, email, verifyCode, isVerified, subscriptions, subscriptionNames, sendVerifyCode, checkVerifyCode, toggleSubscription };
			}
		}).mount("#app");
	</script>
</body>

</html>
